<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Surya Aqua Shrimp Farm</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0f1a;
    --bg2: #0f1729;
    --card: #141e33;
    --card2: #1a2640;
    --border: rgba(100,180,255,0.12);
    --accent: #00d4aa;
    --accent2: #0099ff;
    --profit: #00e676;
    --loss: #ff4444;
    --text: #e8f0ff;
    --muted: #7a90b8;
    --gold: #ffd700;
    --glow: 0 0 30px rgba(0,212,170,0.15);
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    font-family: 'Sora', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Animated background */
  body::before {
    content:'';
    position:fixed;
    top:0; left:0; right:0; bottom:0;
    background: 
      radial-gradient(ellipse at 20% 10%, rgba(0,153,255,0.08) 0%, transparent 50%),
      radial-gradient(ellipse at 80% 80%, rgba(0,212,170,0.06) 0%, transparent 50%);
    pointer-events:none;
    z-index:0;
  }

  .wrapper { position:relative; z-index:1; }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  header {
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding: 20px 32px;
    border-bottom: 1px solid var(--border);
    background: rgba(10,15,26,0.9);
    backdrop-filter: blur(12px);
    position:sticky; top:0; z-index:100;
    flex-wrap: wrap;
    gap: 12px;
  }

  .logo {
    display:flex; align-items:center; gap:12px;
  }
  .logo-icon {
    font-size:28px !important;
    filter: drop-shadow(0 0 8px rgba(0,212,170,0.6));
    animation: float 3s ease-in-out infinite;
  }
  .logo-icon-img {
    font-size:28px !important;
    filter: drop-shadow(0 0 8px rgba(0,212,170,0.6));
    background-image: url('logo.jpg');
    /* Optional: Add other background properties for better control */
    background-repeat: no-repeat; /* Prevents the image from repeating */
    background-size: cover;      /* Scales the image to cover the entire element */
    background-position: center; /* Centers the image */
	width: 35px;
    height: 35px;
	border-radius: 8%;
  }
  .logo-icon-shrimp {
    font-size:28px !important;
    filter: drop-shadow(0 0 8px rgba(0,212,170,0.6));
    background-image: url('shrimp.png');
    /* Optional: Add other background properties for better control */
    background-repeat: no-repeat; /* Prevents the image from repeating */
    background-size: cover;      /* Scales the image to cover the entire element */
    background-position: center; /* Centers the image */
	width: 35px;
    height: 35px;
	border-radius: 8%;
	float: right;
  }
  @keyframes float {
    0%,100%{transform:translateY(0)} 50%{transform:translateY(-4px)}
  }
  .logo h1 {
    font-size:1.1rem; font-weight:800; letter-spacing:0.05em;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  }
  .logo span {
    display:block; font-size:0.65rem; font-weight:400;
    color:var(--muted); letter-spacing:0.15em; text-transform:uppercase;
    -webkit-text-fill-color: var(--muted);
  }

  .upload-area {
    display:flex; align-items:center; gap:12px;
    flex-wrap:wrap;
	display: none;
  }

  .upload-btn {
    display:flex; align-items:center; gap:8px;
    padding:10px 20px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border:none; border-radius:8px;
    color:#000; font-family:'Sora',sans-serif; font-weight:700; font-size:0.8rem;
    cursor:pointer; letter-spacing:0.05em;
    transition: all 0.3s;
    box-shadow: 0 4px 20px rgba(0,212,170,0.3);
  }
  .upload-btn:hover { transform:translateY(-2px); box-shadow: 0 6px 28px rgba(0,212,170,0.45); }
  #fileInput { display:none; }

  .file-name {
    font-size:0.75rem; color:var(--muted); font-family:'JetBrains Mono', monospace;
    max-width:180px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
  }

  /* ‚îÄ‚îÄ Main ‚îÄ‚îÄ */
  main { padding: 28px 32px; max-width:1600px; margin:0 auto; }

  /* ‚îÄ‚îÄ Upload Prompt ‚îÄ‚îÄ */
  .upload-prompt {
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    min-height:60vh; gap:24px; text-align:center;
  }
  .upload-prompt .big-icon { font-size:72px; animation:float 3s ease-in-out infinite; }
  .upload-prompt h2 { font-size:2rem; font-weight:800; color:var(--text); }
  .upload-prompt p { color:var(--muted); font-size:0.9rem; max-width:420px; line-height:1.7; }
  .drop-zone {
    border: 2px dashed rgba(0,212,170,0.4);
    border-radius:16px;
    padding:40px 60px;
    cursor:pointer;
    transition:all 0.3s;
  }
  .drop-zone:hover { border-color:var(--accent); background:rgba(0,212,170,0.04); }

  /* ‚îÄ‚îÄ Summary Cards ‚îÄ‚îÄ */
  .summary-grid {
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap:16px; margin-bottom:28px;
  }
  .stat-card {
    background:var(--card);
    border:1px solid var(--border);
    border-radius:14px;
    padding:20px;
    position:relative; overflow:hidden;
    transition:transform 0.3s, box-shadow 0.3s;
  }
  .stat-card:hover { transform:translateY(-3px); box-shadow:var(--glow); }
  .stat-card::before {
    content:''; position:absolute; top:0; left:0; right:0; height:2px;
    background:linear-gradient(90deg, var(--accent), var(--accent2));
  }
  .stat-label {
    font-size:0.65rem; letter-spacing:0.15em; text-transform:uppercase;
    color:var(--muted); margin-bottom:8px;
  }
  .stat-value {
    font-family:'JetBrains Mono', monospace;
    font-size:1.4rem; font-weight:700;
  }
  .stat-value.green { color:var(--profit); }
  .stat-value.red { color:var(--loss); }
  .stat-value.gold { color:var(--gold); }
  .stat-icon {
    position:absolute; right:16px; top:50%; transform:translateY(-50%);
    font-size:32px; opacity:0.12;
  }

  /* ‚îÄ‚îÄ Chart Section ‚îÄ‚îÄ */
  .charts-row {
    display:grid;
    grid-template-columns: 1fr 280px;
    gap:20px; margin-bottom:28px;
  }

  .chart-card {
    background:var(--card);
    border:1px solid var(--border);
    border-radius:14px;
    padding:24px;
  }
  .chart-card h3 {
    font-size:0.8rem; letter-spacing:0.1em; text-transform:uppercase;
    color:var(--muted); margin-bottom:20px;
    display:flex; align-items:center; gap:8px;
  }
  .chart-card h3::before {
    content:''; display:inline-block; width:10px; height:10px;
    background:linear-gradient(135deg,var(--accent),var(--accent2));
    border-radius:2px;
  }

  .chart-wrap { position:relative; }

  /* ‚îÄ‚îÄ Terms Table ‚îÄ‚îÄ */
  .terms-section { margin-bottom:28px; }
  .terms-section h3 {
    font-size:0.8rem; letter-spacing:0.1em; text-transform:uppercase;
    color:var(--muted); margin-bottom:16px;
    display:flex; align-items:center; gap:8px;
  }
  .terms-section h3::before {
    content:''; display:inline-block; width:10px; height:10px;
    background:linear-gradient(135deg,var(--accent),var(--accent2));
    border-radius:2px;
  }

  .terms-table-wrap { overflow-x:auto; border-radius:14px; border:1px solid var(--border); }
  table {
    width:100%; border-collapse:collapse;
    font-size:0.8rem;
  }
  thead th {
    background:var(--card2);
    padding:14px 16px;
    text-align:left;
    font-size:0.65rem; letter-spacing:0.1em; text-transform:uppercase; color:var(--muted);
    border-bottom:1px solid var(--border);
  }
  tbody tr {
    border-bottom:1px solid rgba(100,180,255,0.05);
    transition:background 0.2s;
  }
  tbody tr:hover { background:rgba(0,212,170,0.04); }
  tbody td { padding:13px 16px; font-family:'JetBrains Mono', monospace; font-size:0.78rem; }
  .badge {
    display:inline-block; padding:3px 10px; border-radius:20px;
    font-size:0.65rem; font-weight:700; letter-spacing:0.05em;
  }
  .badge.profit { background:rgba(0,230,118,0.15); color:var(--profit); }
  .badge.loss { background:rgba(255,68,68,0.15); color:var(--loss); }

  /* ‚îÄ‚îÄ Term Detail Modal / Expandable ‚îÄ‚îÄ */
  .term-detail {
    background:var(--card);
    border:1px solid var(--border);
    border-radius:14px;
    padding:24px;
    margin-bottom:20px;
    display:none;
  }
  .term-detail.show { display:block; animation: slideIn 0.3s ease; }
  @keyframes slideIn { from{opacity:0;transform:translateY(-10px)} to{opacity:1;transform:translateY(0)} }

  .detail-grid {
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap:16px; margin-bottom:20px;
  }

  .detail-section h4 {
    font-size:0.7rem; letter-spacing:0.1em; text-transform:uppercase; color:var(--muted);
    margin-bottom:12px; padding-bottom:6px;
    border-bottom:1px solid var(--border);
  }
  .detail-row {
    display:flex; justify-content:space-between; align-items:center;
    padding:6px 0; font-size:0.78rem;
    border-bottom:1px solid rgba(100,180,255,0.04);
  }
  .detail-row .label { color:var(--muted); }
  .detail-row .val { font-family:'JetBrains Mono', monospace; font-weight:600; }

  .close-btn {
    float:right; background:rgba(255,68,68,0.15); border:none;
    color:var(--loss); border-radius:6px; padding:4px 12px;
    cursor:pointer; font-size:0.75rem; font-family:'Sora',sans-serif;
    transition:background 0.2s;
  }
  .close-btn:hover { background:rgba(255,68,68,0.3); }

  tbody tr.clickable { cursor:pointer; }
  tbody tr.clickable:hover td:first-child { color:var(--accent); }

  /* ‚îÄ‚îÄ Duration info ‚îÄ‚îÄ */
  .meta-bar {
    display:flex; gap:24px; flex-wrap:wrap;
    margin-bottom:24px;
    background:var(--card);
    border:1px solid var(--border);
    border-radius:12px; padding:16px 24px;
    align-items:center;
  }
  .meta-item { display:flex; flex-direction:column; gap:2px; }
  .meta-item .mlabel { font-size:0.6rem; letter-spacing:0.15em; text-transform:uppercase; color:var(--muted); }
  .meta-item .mval { font-family:'JetBrains Mono', monospace; font-size:0.9rem; font-weight:700; color:var(--accent); }

  /* ‚îÄ‚îÄ Responsive: Tablet ‚îÄ‚îÄ */
  @media(max-width:900px) {
    .charts-row { grid-template-columns:1fr; }
    main { padding:16px 12px; }
    header { padding:12px 16px; border: 1px solid #00a7eb; }
    .summary-grid { grid-template-columns: repeat(2,1fr); }
  }

  /* ‚îÄ‚îÄ Responsive: Mobile Portrait ‚îÄ‚îÄ */
  @media(max-width:480px) {
    header {
      flex-direction: column;
      align-items: flex-start;
      padding: 12px;
      gap: 10px;
    }
    .upload-area { width:100%; justify-content:space-between; }
    .upload-btn { padding:9px 16px; font-size:0.75rem; flex:1; justify-content:center; }
    .file-name { max-width:140px; font-size:0.68rem; }

    main { padding:10px 8px; }

    .upload-prompt h2 { font-size:1.3rem; }
    .drop-zone { padding:28px 20px; }
    .upload-prompt .big-icon { font-size:52px; }

    .meta-bar {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      padding:12px;
      margin-bottom:14px;
    }

    .summary-grid {
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-bottom:14px;
    }
    .stat-card { padding:12px 10px; }
    .stat-label { font-size:0.56rem; }
    .stat-value { font-size:0.95rem; }
    .stat-icon { font-size:22px; opacity:0.1; right:8px; }
    .progress-bar-wrap { margin-top:6px; }

    .charts-row { grid-template-columns:1fr; gap:10px; margin-bottom:14px; }
    .chart-card { padding:12px 10px; }
    .chart-card h3 { font-size:0.68rem; margin-bottom:10px; }

    .terms-section { margin-bottom:14px; }
    .terms-section h3 { font-size:0.68rem; margin-bottom:10px; }
    .terms-table-wrap { border-radius:10px; }
    thead th { padding:9px 8px; font-size:0.56rem; white-space:nowrap; }
    tbody td { padding:9px 8px; font-size:0.68rem; }
    thead th:nth-child(2), tbody td:nth-child(2) { display:none; }
    thead th:nth-child(6), tbody td:nth-child(6) { display:none; }
    .badge { padding:2px 7px; font-size:0.58rem; }

    .term-detail { padding:12px 10px; }
    .detail-grid { grid-template-columns:1fr; gap:10px; }
    .detail-row { font-size:0.7rem; }
    .close-btn { font-size:0.7rem; padding:4px 10px; }
  }

  @media(max-width:360px) {
    .summary-grid { grid-template-columns:1fr; }
    .meta-bar { grid-template-columns:1fr; }
  }

  /* Loading shimmer */
  .loading {
    display:flex; align-items:center; justify-content:center;
    gap:8px; color:var(--muted); font-size:0.85rem;
    padding:20px;
  }
  .spinner {
    width:18px; height:18px; border:2px solid var(--border);
    border-top-color:var(--accent); border-radius:50%;
    animation:spin 0.8s linear infinite;
  }
  @keyframes spin { to{transform:rotate(360deg)} }

  .progress-bar-wrap {
    height:4px; background:rgba(100,180,255,0.1); border-radius:2px; overflow:hidden; margin-top:8px;
  }
  .progress-bar { height:100%; border-radius:2px; }
</style>
</head>
<body>
<div class="wrapper">

<header>
  <div class="logo">
    <span class="logo-icon-img"></span>
    <div>
      <h1>SuryaAqua</h1>
      <span>Shrimp Farm Analytics</span>
    </div>
  </div>
  <div class="upload-area">
    <span class="file-name" id="fileName">No file loaded</span>
    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
      üìÇ Load Excel
    </button>
    <input type="file" id="fileInput" accept=".xlsx,.xls" onchange="handleFile(event)">
  </div>
  <span class="logo-icon-shrimp"></span>
</header>

<main>
  <div id="uploadPrompt" class="upload-prompt">
    <div class="drop-zone" onclick="document.getElementById('fileInput').click()">
      <div class="big-icon" id="promptIcon">üìä</div>
      <h2 id="promptTitle">Load Your Farm Data</h2>
      <p id="promptDesc">Upload the Excel file with your shrimp farming terms (Term-1, Term-2...) to generate interactive reports.</p>
      <div id="autoLoadStatus" style="margin-top:16px;display:none">
        <div style="display:flex;align-items:center;justify-content:center;gap:8px;color:var(--muted);font-size:0.82rem">
          <div class="spinner"></div>
          <span id="autoLoadMsg">Loading from configured path...</span>
        </div>
      </div>
    </div>
  </div>

  <div id="dashboard" style="display:none">
    <div class="meta-bar" id="metaBar"></div>
    <div class="summary-grid" id="summaryGrid"></div>
    <div class="charts-row">
      <div class="chart-card">
        <h3>Profit / Loss per Term</h3>
        <div class="chart-wrap">
          <canvas id="barChart" width="100%" height="75%"></canvas>
        </div>
      </div>
      <div class="chart-card">
        <h3>Overall Profit</h3>
        <div class="chart-wrap">
          <canvas id="overallChart"  width="100%" height="75%"></canvas>
        </div>
      </div>
    </div>

    <div class="terms-section">
      <h3>All Terms ‚Äî Click a row for details</h3>
      <div class="terms-table-wrap">
        <table id="termsTable">
          <thead>
            <tr>
              <th>Term</th>
              <th>Investment (‚Çπ)</th>
              <th>Income (‚Çπ)</th>
              <th>Profit/Loss (‚Çπ)</th>
              <th>Status</th>
              <th>Duration</th>
            </tr>
          </thead>
          <tbody id="termsBody"></tbody>
        </table>
      </div>
    </div>

    <div class="term-detail" id="termDetail">
      <button class="close-btn" onclick="closeDetail()">‚úï Close</button>
      <h3 id="detailTitle" style="margin-bottom:16px;font-size:1rem;color:var(--accent)"></h3>
      <div class="detail-grid" id="detailGrid"></div>
    </div>
  </div>
</main>

</div>

<script>
let allTerms = [];
let barChartInst = null;
let overallChartInst = null;

function fmt(n) {
  if (n === undefined || n === null || isNaN(n)) return '‚Äî';
  return '‚Çπ ' + Math.abs(Math.round(n)).toLocaleString('en-IN');
}
function fmtSigned(n) {
  if (n === undefined || n === null || isNaN(n)) return '‚Äî';
  return (n < 0 ? '-' : '+') + '‚Çπ ' + Math.abs(Math.round(n)).toLocaleString('en-IN');
}

function handleFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  document.getElementById('fileName').textContent = file.name;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, { type:'array' });
      parseWorkbook(wb);
    } catch(err) {
      alert('Error reading file: ' + err.message);
    }
  };
  reader.readAsArrayBuffer(file);
}

function parseWorkbook(wb) {
  // Find all term sheets (named term1, term2... or Term1, Term2...)
  const termSheets = wb.SheetNames.filter(n => /term-/i.test(n));
  if (termSheets.length === 0) {
    alert('No sheets matching "Term-" found. Please check your sheet names.');
    return;
  }

  allTerms = termSheets.map((name, idx) => {
    const ws = wb.Sheets[name];
    return parseTermSheet(ws, name, idx + 1);
  });

  renderDashboard();
}

function getCellVal(ws, addr) {
  const cell = ws[addr];
  if (!cell) return null;
  return cell.v;
}
function excelDateToJSDate(excelDate) {
	if (typeof excelDate === 'number'){
		// 25569 is the number of days from 1900-01-01 to 1970-01-01
		const date = new Date((excelDate - 25569) * 86400 * 1000); 
		// Handle potential timezone offsets
		// date.setTime(date.getTime() + (date.getTimezoneOffset() * 60000));
		return date.toDateString();
	}else{
		const date = new Date(excelDate);
		return date.toDateString();
	}
}
function daysBetweenToday(startDate) {
	//const today = new Date();
	startDate = new Date('2023-04-01');
	//var startDate = new Date(date);
    var diffDate = new Date(new Date() - startDate);
    return ((diffDate.toISOString().slice(0, 4) - 1970) + "Y " + diffDate.getMonth() + "M " + (diffDate.getDate()-1) + "D");
}

function parseTermSheet(ws, sheetName, termNum) {
  // Convert sheet to array of arrays for flexible parsing
  const range = XLSX.utils.decode_range(ws['!ref'] || 'A1:Z100');
  const rows = [];
  for (let r = range.s.r; r <= range.e.r; r++) {
    const row = [];
    for (let c = range.s.c; c <= range.e.c; c++) {
      const addr = XLSX.utils.encode_cell({r, c});
      const cell = ws[addr];
      row.push(cell ? (cell.v !== undefined ? cell.v : '') : '');
    }
    rows.push(row);
  }

  // Helper: find a value in sheet by searching for a label pattern
  function findByLabel(label) {
    for (let r=0; r<rows.length; r++) {	
      for (let c=0; c<rows[r].length; c++) {
        const v = String(rows[r][c] || '').toLowerCase().replace(/\s+/g,'');
        if (v.includes(label.toLowerCase().replace(/\s+/g,''))) {
          // Value is likely next cell
          if (rows[r][c+1] !== '' && rows[r][c+1] !== undefined) return rows[r][c+1];
          if (rows[r+1] && rows[r+1][c] !== '' && rows[r+1][c] !== undefined) return rows[r+1][c];
        }
      }
    }
    return null;
  }

  // Extract known fields
  let seedDate = findByLabel('SeedDate') || findByLabel('Seed Date');
  let days = findByLabel('Days');
  let totalInvestment = null, totalIncome = null, profit = null;

  // Scan for Total: / Profit values
  for (let r=0; r<rows.length; r++) {
    for (let c=0; c<rows[r].length; c++) {
      const v = String(rows[r][c] || '').toLowerCase();
      if (v === 'total:' || v === 'total') {
        // Check context: if col header says Investment, next numeric = investment
        const next = rows[r][c+1];
        if (typeof next === 'number') {
          if (!totalInvestment) totalInvestment = next;
          else if (!totalIncome) totalIncome = next;
        }
      }
      if (v.includes('profit') || v.includes('profi')) {
        const next = rows[r][c+1];
        if (typeof next === 'number') profit = next;
      }
    }
  }

  // Collect investment rows
  const investments = [];
  const incomes = [];
  const growthData = [];

  // Determine column structure from header row
  // Look for "Investment" / "Growth" / "Income" column headers
  let invStartCol = -1, growthStartCol = -1, incomeStartCol = -1;
  for (let r=0; r<10; r++) {
    for (let c=0; c<rows[r].length; c++) {
      const v = String(rows[r][c] || '').toLowerCase();
      if (v === 'investment') invStartCol = c;
      if (v === 'growth') growthStartCol = c;
      if (v === 'income') incomeStartCol = c;
    }
  }

  // Scan investment section (rows after header, col ~0-4)
  if (invStartCol >= 0) {
    for (let r=3; r<rows.length; r++) {
	  //console.log("rows:",rows);
      const item = rows[r][invStartCol + 2];
      const amount = rows[r][invStartCol + 3];
      if (item && typeof amount === 'number') {
        investments.push({ item: String(item), amount });
      }
    }
  } else {
    // Fallback: look for rows with item label + numeric amount in first 5 cols
    for (let r=3; r<rows.length; r++) {
      for (let c=0; c<5; c++) {
        if (typeof rows[r][c] === 'string' && rows[r][c].length > 1) {
          const possibleAmt = rows[r][c+1];
          if (typeof possibleAmt === 'number' && possibleAmt > 0 && r<26) {
            investments.push({ item: rows[r][c], amount: possibleAmt });
          }
        }
      }
    }
  }

  // Collect income rows
  if (incomeStartCol >= 0) {
    for (let r=3; r<rows.length; r++) {
      const item = rows[r][incomeStartCol + 2];
      const amount = rows[r][incomeStartCol + 3];
      if (item && typeof amount === 'number' && r<26) {
        incomes.push({ item: String(item), amount });
      }
    }
  }

  // Sum investments/incomes
  //console.log("incomes",incomes)
  const sumInv = investments.reduce((a, b) => a + b.amount, 0);
  const sumInc = incomes.reduce((a, b) => a + b.amount, 0);
  //console.log("sumInv",sumInv)
  totalInvestment = sumInv;
  //if (!totalInvestment && sumInv > 0) totalInvestment = sumInv;
  totalIncome = sumInc;
  //if (!totalIncome && sumInc > 0) totalIncome = sumInc;
  if (!profit && totalInvestment && totalIncome) profit = totalIncome - totalInvestment;

  // Parse growth data
  if (growthStartCol >= 0) {
    for (let r=3; r<rows.length; r++) {
      const date = rows[r][growthStartCol+2];
      const count = rows[r][growthStartCol + 1];
      if (date && r < 12) {
        growthData.push({ date: String(date), count });
      }
    }
  }
  return {
    termNum, sheetName,
    seedDate: seedDate ? excelDateToJSDate(seedDate) : null,
    days: days,
    totalInvestment: totalInvestment || 0,
    totalIncome: totalIncome || 0,
    profit: profit || (totalIncome - totalInvestment) || 0,
    investments,
    incomes,
    growthData,
  };
}

function renderDashboard() {
  document.getElementById('uploadPrompt').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';

  const totalProfit = allTerms.reduce((a, b) => a + (b.profit || 0), 0);
  const totalInv = allTerms.reduce((a, b) => a + (b.totalInvestment || 0), 0);
  const totalInc = allTerms.reduce((a, b) => a + (b.totalIncome || 0), 0);
  const profitTerms = allTerms.filter(t => t.profit > 0).length;
  const lossTerms = allTerms.filter(t => t.profit <= 0).length;

  // Meta bar
  const firstTerm = allTerms[0];
  const meta = document.getElementById('metaBar');
  meta.innerHTML = `
    <div class="meta-item"><span class="mlabel">Total Terms</span><span class="mval">${allTerms.length}</span></div>
	<div class="meta-item"><span class="mlabel">Total Duration</span><span class="mval">${daysBetweenToday(new Date(allTerms[0].seedDate))}</span></div>
    <div class="meta-item"><span class="mlabel">Profit Terms</span><span class="mval" style="color:var(--profit)">${profitTerms}</span></div>
    <div class="meta-item"><span class="mlabel">Loss Terms</span><span class="mval" style="color:var(--loss)">${lossTerms}</span></div>
    <div class="meta-item"><span class="mlabel">Total Investment</span><span class="mval">${fmt(totalInv)}</span></div>
    <div class="meta-item"><span class="mlabel">Total Income</span><span class="mval">${fmt(totalInc)}</span></div>
  `;

  // Summary cards
  const grid = document.getElementById('summaryGrid');
  grid.innerHTML = `
    <div class="stat-card">
      <div class="stat-label">Overall Profit / Loss</div>
      <div class="stat-value ${totalProfit >= 0 ? 'green' : 'red'}">${fmtSigned(totalProfit)}</div>
      <div class="progress-bar-wrap"><div class="progress-bar" style="width:100%;background:${totalProfit>=0?'var(--profit)':'var(--loss)'}"></div></div>
      <span class="stat-icon">üíπ</span>
    </div>
    <!--<div class="stat-card">
      <div class="stat-label">Total Investment</div>
      <div class="stat-value">${fmt(totalInv)}</div>
      <span class="stat-icon">üì•</span>
    </div>
    <div class="stat-card">
      <div class="stat-label">Total Income</div>
      <div class="stat-value gold">${fmt(totalInc)}</div>
      <span class="stat-icon">üì§</span>
    </div>-->
	<div class="stat-card">
      <div class="stat-label">Avg Profit / Term</div>
      <div class="stat-value ${totalProfit/allTerms.length >= 0 ?'green':'red'}">${fmt(totalProfit/allTerms.length)}</div>
      <span class="stat-icon">üìä</span>
    </div>
    <div class="stat-card">
      <div class="stat-label">Best Term</div>
      ${(() => {
        const best = allTerms.reduce((a,b)=>b.profit>a.profit?b:a, allTerms[0]);
        return `<div class="stat-value green">${best.sheetName}</div>
          <div style="font-size:0.75rem;color:var(--muted);margin-top:4px">${fmt(best.profit)}</div>`;
      })()}
      <span class="stat-icon">üèÜ</span>
    </div>
    <div class="stat-card">
      <div class="stat-label">Worst Term</div>
      ${(() => {
        const worst = allTerms.reduce((a,b)=>b.profit<a.profit?b:a, allTerms[0]);
        return `<div class="stat-value red">${worst.sheetName}</div>
          <div style="font-size:0.75rem;color:var(--muted);margin-top:4px">${fmtSigned(worst.profit)}</div>`;
      })()}
      <span class="stat-icon">üìâ</span>
    </div>
  `;

  renderCharts(totalProfit, totalInv);
  renderTable();
}

function renderCharts(totalProfit, totalInv) {
  const labels = allTerms.map(t => t.sheetName);
  const profits = allTerms.map(t => Math.round(t.profit || 0));
  const colors = profits.map(p => p >= 0 ? 'rgba(0,230,118,0.85)' : 'rgba(255,68,68,0.85)');
  const borderColors = profits.map(p => p >= 0 ? 'rgba(0,230,118,1)' : 'rgba(255,68,68,1)');

  Chart.defaults.color = '#7a90b8';
  Chart.defaults.font.family = "'Sora', sans-serif";
  Chart.defaults.font.size = 11;

  if (barChartInst) barChartInst.destroy();
  const barCtx = document.getElementById('barChart').getContext('2d');
  barChartInst = new Chart(barCtx, {
    type:'bar',
    data:{
      labels,
      datasets:[{
        label:'Profit / Loss (‚Çπ)',
        data: profits,
        backgroundColor: colors,
        borderColor: borderColors,
        borderWidth: 1,
        borderRadius: 4,
      }]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{display:false},
        tooltip:{
          callbacks:{
            label: ctx => ' ‚Çπ ' + Math.abs(ctx.raw).toLocaleString('en-IN') + (ctx.raw < 0 ? ' (Loss)' : ' (Profit)')
          }
        },
        annotation: {}
      },
      scales:{
        x:{ grid:{color:'rgba(100,180,255,0.05)'}, ticks:{color:'#7a90b8'} },
        y:{ grid:{color:'rgba(100,180,255,0.08)'}, ticks:{
          callback: v => '‚Çπ' + (Math.abs(v)/100000).toFixed(1)+'L'
        }},
      }
    }
  });

  // Overall profit doughnut/bar
  if (overallChartInst) overallChartInst.destroy();
  const oCtx = document.getElementById('overallChart').getContext('2d');
  overallChartInst = new Chart(oCtx, {
    type:'bar',
    data:{
      labels:['Total\nInvestment','Total\nIncome','Overall\nProfit'],
      datasets:[{
        data:[Math.round(totalInv), Math.round(allTerms.reduce((a,b)=>a+b.totalIncome,0)), Math.round(totalProfit)],
        backgroundColor:['rgba(0,153,255,0.7)','rgba(255,215,0,0.7)','rgba(0,230,118,0.85)'],
        borderColor:['rgba(0,153,255,1)','rgba(255,215,0,1)','rgba(0,230,118,1)'],
        borderWidth:1, borderRadius:6,
      }]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{display:false},
        tooltip:{
          callbacks:{label: ctx => ' ‚Çπ ' + Math.abs(ctx.raw).toLocaleString('en-IN')}
        }
      },
      scales:{
        x:{grid:{display:false}},
        y:{grid:{color:'rgba(100,180,255,0.08)'},ticks:{
          callback: v => '‚Çπ'+(Math.abs(v)/100000).toFixed(0)+'L'
        }}
      }
    }
  });
}

function renderTable() {
  const tbody = document.getElementById('termsBody');
  console.log("allTerms:",allTerms);
  tbody.innerHTML = allTerms.map((t, i) => `
    <tr class="clickable" onclick="showDetail(${i})">
      <td style="font-weight:700;color:var(--accent)">${t.sheetName}</td>
      <td>${fmt(t.totalInvestment)}</td>
      <td>${fmt(t.totalIncome)}</td>
      <td style="color:${t.profit>=0?'var(--profit)':'var(--loss)'}; font-weight:700">${fmtSigned(t.profit)}</td>
      <td><span class="badge ${t.profit>=0?'profit':'loss'}">${t.profit>=0?'PROFIT':'LOSS'}</span></td>
      <td>${t.days ? t.days : t.seedDate || '‚Äî'}</td>
    </tr>
  `).join('');
}

function showDetail(idx) {
  const t = allTerms[idx];
  const detail = document.getElementById('termDetail');
  document.getElementById('detailTitle').textContent = `üìã ${t.sheetName} ‚Äî Detailed Breakdown`;

  let invHtml = t.investments.length ? t.investments.map(i =>
    `<div class="detail-row"><span class="label">${i.item}</span><span class="val">${fmt(i.amount)}</span></div>`
  ).join('') : '<div class="detail-row"><span class="label" style="font-style:italic">No detail data parsed</span></div>';

  let incHtml = t.incomes.length ? t.incomes.map(i =>
    `<div class="detail-row"><span class="label">${i.item}</span><span class="val">${fmt(i.amount)}</span></div>`
  ).join('') : '<div class="detail-row"><span class="label" style="font-style:italic">No detail data parsed</span></div>';

  document.getElementById('detailGrid').innerHTML = `
    <div class="detail-section">
      <h4>üå± Investment</h4>
      ${invHtml}
      <div class="detail-row" style="margin-top:8px;border-top:1px solid var(--border);padding-top:8px">
        <span class="label" style="font-weight:700">Total</span>
        <span class="val">${fmt(t.totalInvestment)}</span>
      </div>
    </div>
    <div class="detail-section">
      <h4>üí∞ Income</h4>
      ${incHtml}
      <div class="detail-row" style="margin-top:8px;border-top:1px solid var(--border);padding-top:8px">
        <span class="label" style="font-weight:700">Total</span>
        <span class="val">${fmt(t.totalIncome)}</span>
      </div>
    </div>
    <div class="detail-section">
      <h4>üìà Summary</h4>
      <div class="detail-row"><span class="label">Seed Date</span><span class="val">${t.seedDate || '‚Äî'}</span></div>
      <div class="detail-row"><span class="label">Duration</span><span class="val">${t.days ? t.days : '‚Äî'}</span></div>
      <div class="detail-row"><span class="label">Investment</span><span class="val">${fmt(t.totalInvestment)}</span></div>
      <div class="detail-row"><span class="label">Income</span><span class="val">${fmt(t.totalIncome)}</span></div>
      <div class="detail-row">
        <span class="label">Net Profit/Loss</span>
        <span class="val" style="color:${t.profit>=0?'var(--profit)':'var(--loss)'}">${fmtSigned(t.profit)}</span>
      </div>
      <div class="detail-row">
        <span class="label">ROI</span>
        <span class="val" style="color:${t.profit>=0?'var(--profit)':'var(--loss)'}">
          ${t.totalInvestment ? ((t.profit/t.totalInvestment)*100).toFixed(1) + '%' : '‚Äî'}
        </span>
      </div>
    </div>
    ${t.growthData.length ? `
    <div class="detail-section">
      <h4>üìä Growth Counts</h4>
      ${t.growthData.slice(0,8).map(g =>
        `<div class="detail-row"><span class="label">${g.date}</span><span class="val">${g.count.toLocaleString()}</span></div>`
      ).join('')}
    </div>` : ''}
  `;

  detail.classList.add('show');
  detail.scrollIntoView({ behavior:'smooth', block:'nearest' });
}

function closeDetail() {
  document.getElementById('termDetail').classList.remove('show');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AUTO-LOAD CONFIGURATION
   Update EXCEL_FILE_PATH to your file's URL or
   relative path, then reload the page.
   Examples:
     './data/farm.xlsx'
     'https://example.com/files/farm.xlsx'
     '/files/shrimp_farm_2024.xlsx'
   Set to null or '' to disable auto-load.
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const EXCEL_FILE_PATH = 'data.xlsx';   // ‚Üê UPDATE THIS PATH

async function autoLoad() {
  if (!EXCEL_FILE_PATH) return;

  // Show loading state
  document.getElementById('autoLoadStatus').style.display = 'block';
  document.getElementById('autoLoadMsg').textContent = 'Loading: ' + EXCEL_FILE_PATH;
  document.getElementById('promptIcon').textContent = '‚è≥';
  document.getElementById('promptTitle').textContent = 'Auto-loading...';

  try {
    const res = await fetch(EXCEL_FILE_PATH);
    if (!res.ok) throw new Error('HTTP ' + res.status + ' ‚Äî ' + res.statusText);
    const arrayBuffer = await res.arrayBuffer();
    const data = new Uint8Array(arrayBuffer);
    const wb = XLSX.read(data, { type: 'array', cellDates: true });

    // Show filename in header
    const parts = EXCEL_FILE_PATH.split('/');
    document.getElementById('fileName').textContent = parts[parts.length - 1];

    parseWorkbook(wb);
  } catch (err) {
    document.getElementById('promptIcon').textContent = '‚ö†Ô∏è';
    document.getElementById('promptTitle').textContent = 'Auto-load failed';
    document.getElementById('autoLoadMsg').textContent = err.message + ' ‚Äî Use the button above to load manually.';
    console.error('Auto-load error:', err);
  }
}

window.addEventListener('DOMContentLoaded', autoLoad);
</script>
</body>
</html>
